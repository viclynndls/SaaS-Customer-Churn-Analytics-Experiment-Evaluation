USE DATABASE CX_ANALYTICS;

SHOW TABLES IN SCHEMA TRANSFORM;
SHOW TABLES IN SCHEMA ANALYTICS;

-- Row Counts
-- Users
SELECT 'STG_USERS' AS TABLE_NAME, COUNT(*) FROM TRANSFORM.STG_USERS
UNION ALL
SELECT 'DIM_USERS', COUNT(*) FROM ANALYTICS.DIM_USERS;

-- Events
SELECT 'STG_EVENTS', COUNT(*) FROM TRANSFORM.STG_EVENTS
UNION ALL
SELECT 'FACT_EVENTS', COUNT(*) FROM ANALYTICS.FACT_EVENTS;

-- Subscriptions
SELECT 'STG_SUBSCRIPTIONS', COUNT(*) FROM TRANSFORM.STG_SUBSCRIPTIONS
UNION ALL
SELECT 'FACT_SUBSCRIPTIONS', COUNT(*) FROM ANALYTICS.FACT_SUBSCRIPTIONS_CLEAN;

-- Surveys
SELECT 'STG_SURVEY_RESPONSES', COUNT(*) FROM TRANSFORM.STG_SURVEYS
UNION ALL
SELECT 'FACT_SURVEY_RESPONSES', COUNT(*) FROM ANALYTICS.FACT_SURVEY_RESPONSES;

-- Experiments
SELECT 'STG_EXPERIMENT_ASSIGNMENTS', COUNT(*) FROM TRANSFORM.STG_EXPERIMENT_ASSIGNMENTS
UNION ALL
SELECT 'FACT_EXPERIMENT_ASSIGNMENTS', COUNT(*) FROM ANALYTICS.FACT_EXPERIMENT_ASSIGNMENTS;



-- Distinct users by table
SELECT 'DIM_USERS' AS TABLE_NAME, COUNT(DISTINCT USER_ID) AS DISTINCT_USERS
FROM ANALYTICS.DIM_USERS
UNION ALL
SELECT 'FACT_EVENTS', COUNT(DISTINCT USER_ID) FROM ANALYTICS.FACT_EVENTS
UNION ALL
SELECT 'FACT_SUBSCRIPTIONS_CLEAN', COUNT(DISTINCT USER_ID) FROM ANALYTICS.FACT_SUBSCRIPTIONS_CLEAN
UNION ALL
SELECT 'FACT_SURVEY_RESPONSES', COUNT(DISTINCT USER_ID) FROM ANALYTICS.FACT_SURVEY_RESPONSES
UNION ALL
SELECT 'FACT_EXPERIMENT_ASSIGNMENTS', COUNT(DISTINCT USER_ID) FROM ANALYTICS.FACT_EXPERIMENT_ASSIGNMENTS;


-- Check for unknown users
-- Events
SELECT COUNT(*) AS EVENTS_WITH_UNKNOWN_USERS
FROM ANALYTICS.FACT_EVENTS e
LEFT JOIN ANALYTICS.DIM_USERS u
  ON e.USER_ID = u.USER_ID
WHERE u.USER_ID IS NULL;

-- Subs
SELECT COUNT(*) AS SUBS_WITH_UNKNOWN_USERS
FROM ANALYTICS.FACT_SUBSCRIPTIONS_CLEAN s
LEFT JOIN ANALYTICS.DIM_USERS u
  ON s.USER_ID = u.USER_ID
WHERE u.USER_ID IS NULL;

-- Surveys
SELECT COUNT(*) AS SURVEYS_WITH_UNKNOWN_USERS
FROM ANALYTICS.FACT_SURVEY_RESPONSES r
LEFT JOIN ANALYTICS.DIM_USERS u
  ON r.USER_ID = u.USER_ID
WHERE u.USER_ID IS NULL;

-- Experiments
SELECT COUNT(*) AS EXPS_WITH_UNKNOWN_USERS
FROM ANALYTICS.FACT_EXPERIMENT_ASSIGNMENTS a
LEFT JOIN ANALYTICS.DIM_USERS u
  ON a.USER_ID = u.USER_ID
WHERE u.USER_ID IS NULL;


-- Validity
SELECT COUNT(*) AS KNOWN_USERS_NOT_IN_DIM
FROM ANALYTICS.FACT_EVENTS e
LEFT JOIN ANALYTICS.DIM_USERS u
  ON e.USER_ID = u.USER_ID
WHERE e.IS_KNOWN_USER = TRUE
  AND u.USER_ID IS NULL;



-- Date checks
-- Users
SELECT MIN(SIGNUP_DATE) AS MIN_SIGNUP,
       MAX(SIGNUP_DATE) AS MAX_SIGNUP
FROM ANALYTICS.DIM_USERS;

-- Events
SELECT MIN(EVENT_DATE) AS MIN_EVENT,
       MAX(EVENT_DATE) AS MAX_EVENT
FROM ANALYTICS.FACT_EVENTS;

-- Subs
SELECT MIN(START_DATE) AS MIN_SUB_START,
       MAX(END_DATE)   AS MAX_SUB_END
FROM ANALYTICS.FACT_SUBSCRIPTIONS_CLEAN;



-- Duration checks
SELECT COUNT(*) AS NEGATIVE_DURATION
FROM ANALYTICS.FACT_SUBSCRIPTIONS_CLEAN
WHERE DURATION_DAYS < 0;

SELECT MIN(DURATION_DAYS) AS MIN_DURATION,
       MAX(DURATION_DAYS) AS MAX_DURATION
FROM ANALYTICS.FACT_SUBSCRIPTIONS_CLEAN;




-- Price sanity
SELECT MIN(PRICE_USD) AS MIN_PRICE,
       MAX(PRICE_USD) AS MAX_PRICE
FROM ANALYTICS.FACT_SUBSCRIPTIONS_CLEAN;


-- Distribution checks
SELECT PLAN_TYPE, COUNT(*) AS USERS
FROM ANALYTICS.DIM_USERS
GROUP BY PLAN_TYPE
ORDER BY USERS DESC;

SELECT ACQUISITION_CHANNEL, COUNT(*) AS USERS
FROM ANALYTICS.DIM_USERS
GROUP BY ACQUISITION_CHANNEL
ORDER BY USERS DESC;


SELECT PRIMARY_DEVICE, COUNT(*) AS USERS
FROM ANALYTICS.DIM_USERS
GROUP BY PRIMARY_DEVICE
ORDER BY USERS DESC;

SELECT EVENT_TYPE, COUNT(*) AS EVENTS
FROM ANALYTICS.FACT_EVENTS
GROUP BY EVENT_TYPE
ORDER BY EVENTS DESC;

SELECT NPS_CATEGORY, COUNT(*) AS RESPONSES
FROM ANALYTICS.FACT_SURVEY_RESPONSES
GROUP BY NPS_CATEGORY
ORDER BY RESPONSES DESC;

SELECT CSAT_CATEGORY, COUNT(*) AS RESPONSES
FROM ANALYTICS.FACT_SURVEY_RESPONSES
GROUP BY CSAT_CATEGORY
ORDER BY RESPONSES DESC;

SELECT EXPERIMENT_NAME, VARIANT, COUNT(*) AS ASSIGNMENTS
FROM ANALYTICS.FACT_EXPERIMENT_ASSIGNMENTS
GROUP BY EXPERIMENT_NAME, VARIANT
ORDER BY EXPERIMENT_NAME, VARIANT;


-- Sample Joins
SELECT
    u.USER_ID,
    u.PLAN_TYPE,
    u.ACQUISITION_CHANNEL,
    e.EVENT_DATE,
    e.EVENT_TYPE,
    s.START_DATE,
    s.END_DATE,
    r.RESPONSE_DATE,
    a.EXPERIMENT_NAME,
    a.VARIANT
FROM ANALYTICS.DIM_USERS u
LEFT JOIN ANALYTICS.FACT_EVENTS e
    ON u.USER_ID = e.USER_ID
LEFT JOIN ANALYTICS.FACT_SUBSCRIPTIONS s
    ON u.USER_ID = s.USER_ID
LEFT JOIN ANALYTICS.FACT_SURVEY_RESPONSES r
    ON u.USER_ID = r.USER_ID
LEFT JOIN ANALYTICS.FACT_EXPERIMENT_ASSIGNMENTS a
    ON u.USER_ID = a.USER_ID
LIMIT 50;
