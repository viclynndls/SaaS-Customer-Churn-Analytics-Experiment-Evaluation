USE DATABASE CX_ANALYTICS;
USE SCHEMA ANALYTICS;

SET REF_DATE = TO_DATE('2024-12-31');

CREATE OR REPLACE TABLE USER_EVENTS_AGG AS
WITH base AS (
    SELECT
        e.USER_ID,
        e.EVENT_DATE,
        e.EVENT_TYPE,
        e.IS_ENGAGEMENT_EVENT
    FROM ANALYTICS.FACT_EVENTS e
    JOIN ANALYTICS.DIM_USERS u
      ON e.USER_ID = u.USER_ID      -
    WHERE e.IS_KNOWN_USER = TRUE
)
SELECT
    USER_ID,
    COUNT(*)                              AS TOTAL_EVENTS,
    COUNT(DISTINCT EVENT_DATE)            AS ACTIVE_DAYS,
    COUNT_IF(IS_ENGAGEMENT_EVENT = 1)     AS ENGAGEMENT_EVENTS,
    MIN(EVENT_DATE)                       AS FIRST_EVENT_DATE,
    MAX(EVENT_DATE)                       AS LAST_EVENT_DATE,

    
    COUNT_IF(EVENT_DATE >= DATEADD('day', -30, $REF_DATE)) AS EVENTS_LAST_30D,
    COUNT_IF(EVENT_DATE >= DATEADD('day', -7,  $REF_DATE)) AS EVENTS_LAST_7D

FROM base
GROUP BY USER_ID;

--Sanity Check
SELECT * FROM USER_EVENTS_AGG LIMIT 20;

