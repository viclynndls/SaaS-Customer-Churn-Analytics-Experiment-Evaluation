USE DATABASE CX_ANALYTICS;
USE SCHEMA ANALYTICS;

CREATE OR REPLACE TABLE USER_SUBSCRIPTION_AGG AS
SELECT
    s.USER_ID,
    COUNT(*) AS NUM_SUBSCRIPTIONS,
    SUM(s.PRICE_USD) AS TOTAL_REVENUE,

    MAX(s.START_DATE) AS LAST_SUB_START,
    MAX(s.END_DATE)   AS LAST_SUB_END,

    MAX(CASE WHEN s.IS_ACTIVE = TRUE THEN 1 ELSE 0 END) AS HAS_ACTIVE_SUB

FROM ANALYTICS.FACT_SUBSCRIPTIONS_CLEAN s
JOIN ANALYTICS.DIM_USERS u
  ON s.USER_ID = u.USER_ID
WHERE s.IS_KNOWN_USER = TRUE
  AND s.IS_PRICE_VALID = TRUE
  AND s.IS_DURATION_VALID_CLEAN = TRUE
GROUP BY s.USER_ID;

-- Sanity Check
SELECT * FROM USER_SUBSCRIPTION_AGG LIMIT 20;