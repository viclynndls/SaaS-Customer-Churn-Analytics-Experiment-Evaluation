USE DATABASE CX_ANALYTICS;
USE SCHEMA ANALYTICS;


CREATE OR REPLACE TABLE USER_EXPERIMENT_AGG AS
SELECT
    a.USER_ID,
    a.EXPERIMENT_NAME,
    MAX(a.ASSIGNMENT_DATE) AS LAST_ASSIGNMENT_DATE,
    ANY_VALUE(a.VARIANT)   AS VARIANT,
    MAX(a.IS_TREATMENT)    AS IS_TREATMENT
FROM ANALYTICS.FACT_EXPERIMENT_ASSIGNMENTS a
JOIN ANALYTICS.DIM_USERS u
  ON a.USER_ID = u.USER_ID
WHERE a.IS_KNOWN_USER = TRUE
GROUP BY a.USER_ID, a.EXPERIMENT_NAME;



-- Sanity Check
SELECT * FROM USER_EXPERIMENT_AGG LIMIT 20;
