USE DATABASE CX_ANALYTICS;
USE SCHEMA ANALYTICS;


SET REF_DATE = TO_DATE('2024-12-31');

CREATE OR REPLACE TABLE FTR_CHURN AS
SELECT
    u.USER_ID,

    -- Demographics & signup
    u.SIGNUP_DATE,
    u.SIGNUP_MONTH,
    u.COUNTRY,
    u.AGE,
    u.AGE_BUCKET,
    u.GENDER,
    u.PLAN_TYPE,

    -- Events / behavior
    COALESCE(e.TOTAL_EVENTS, 0)           AS TOTAL_EVENTS,
    COALESCE(e.ACTIVE_DAYS, 0)            AS ACTIVE_DAYS,
    COALESCE(e.ENGAGEMENT_EVENTS, 0)      AS ENGAGEMENT_EVENTS,
    e.FIRST_EVENT_DATE,
    e.LAST_EVENT_DATE,
    COALESCE(e.EVENTS_LAST_30D, 0)        AS EVENTS_LAST_30D,
    COALESCE(e.EVENTS_LAST_7D, 0)         AS EVENTS_LAST_7D,

    -- Subscription features
    COALESCE(s.NUM_SUBSCRIPTIONS, 0)      AS NUM_SUBSCRIPTIONS,
    COALESCE(s.TOTAL_REVENUE, 0)          AS TOTAL_REVENUE,
    s.LAST_SUB_START,
    s.LAST_SUB_END,
    COALESCE(s.HAS_ACTIVE_SUB, 0)         AS HAS_ACTIVE_SUB,

    -- Survey / CX features
    COALESCE(sa.NUM_SURVEYS, 0)               AS NUM_SURVEYS,
    CASE WHEN sa.NUM_SURVEYS IS NULL OR sa.NUM_SURVEYS = 0 THEN 1 ELSE 0 END AS NO_SURVEY_FLAG,
    sa.AVG_NPS_SCORE             AS AVG_NPS_SCORE,
    sa.AVG_CSAT_0_TO_10          AS AVG_CSAT_0_TO_10,
    COALESCE(sa.PCT_PROMOTER, 0)              AS PCT_PROMOTER,
    COALESCE(sa.PCT_DETRACTOR, 0)             AS PCT_DETRACTOR,
    COALESCE(sa.PCT_WITH_MEANINGFUL_COMMENT, 0) AS PCT_WITH_MEANINGFUL_COMMENT,
    sa.LAST_SURVEY_DATE,

    -- Experiment
    COALESCE(exp.VARIANT, 'no_experiment') AS EXPERIMENT_VARIANT,
    COALESCE(exp.IS_TREATMENT, 0)          AS IS_TREATMENT,

    -- Churn label + recency
    c.LAST_EVENT_DATE        AS LABEL_LAST_EVENT_DATE,
    c.LAST_SUB_END           AS LABEL_LAST_SUB_END,
    c.DAYS_SINCE_LAST_EVENT,                -- now never negative
    c.CHURNED_AS_OF_REF_DATE AS CHURNED

FROM ANALYTICS.DIM_USERS u

-- Events aggregate
LEFT JOIN ANALYTICS.USER_EVENTS_AGG       e
  ON u.USER_ID = e.USER_ID

-- Subscriptions aggregate
LEFT JOIN ANALYTICS.USER_SUBSCRIPTION_AGG s
  ON u.USER_ID = s.USER_ID

-- Survey aggregate
LEFT JOIN ANALYTICS.USER_SURVEY_AGG       sa
  ON u.USER_ID = sa.USER_ID

-- Experiment: pull exactly one experiment into features
LEFT JOIN ANALYTICS.USER_EXPERIMENT_AGG   exp
  ON u.USER_ID = exp.USER_ID
 AND exp.EXPERIMENT_NAME = 'onboarding_v2'   

-- Churn label
LEFT JOIN ANALYTICS.USER_CHURN_LABEL      c
  ON u.USER_ID = c.USER_ID;




-- Sanity Check
SELECT * FROM FTR_CHURN LIMIT 20;

SELECT CHURNED, COUNT(*) AS USERS
FROM FTR_CHURN
GROUP BY CHURNED;

SELECT MIN(DAYS_SINCE_LAST_EVENT) AS MIN_DAYS,
       MAX(DAYS_SINCE_LAST_EVENT) AS MAX_DAYS
FROM FTR_CHURN;
