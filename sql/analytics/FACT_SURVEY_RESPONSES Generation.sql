USE DATABASE CX_ANALYTICS;
USE SCHEMA ANALYTICS;

CREATE OR REPLACE TABLE FACT_SURVEY_RESPONSES AS
SELECT
    r.RESPONSE_ID,
    r.USER_ID,
    r.RESPONSE_DATE,
    r.NPS_SCORE,
    r.NPS_CATEGORY,
    r.CSAT_SCORE,
    r.CSAT_CATEGORY,
    r.EASE_OF_USE,
    r.COMMENT_TEXT,
    r.COMMENT_TEXT_CLEAN,
    r.HAS_URL,
    r.HAS_HTML,
    r.IS_KNOWN_USER,


    -- CSAT as 0â€“10
    CASE
        WHEN r.CSAT_SCORE IS NOT NULL THEN (r.CSAT_SCORE - 1) * 2.5
        ELSE NULL
    END AS CSAT_SCORE_0_TO_10,

    -- Simple text-richness indicator
    CASE
        WHEN r.COMMENT_TEXT_CLEAN IS NOT NULL AND LENGTH(r.COMMENT_TEXT_CLEAN) > 50
            THEN 1
        ELSE 0
    END AS HAS_MEANINGFUL_COMMENT

FROM CX_ANALYTICS.TRANSFORM.STG_SURVEYS r;
