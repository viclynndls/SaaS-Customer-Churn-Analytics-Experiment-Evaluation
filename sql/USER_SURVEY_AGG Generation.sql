USE DATABASE CX_ANALYTICS;
USE SCHEMA ANALYTICS;

CREATE OR REPLACE TABLE USER_SURVEY_AGG AS
SELECT
    USER_ID,
    COUNT(*)                        AS NUM_SURVEYS,
    AVG(NPS_SCORE)                  AS AVG_NPS_SCORE,
    AVG(CSAT_SCORE_0_TO_10)         AS AVG_CSAT_0_TO_10,
    AVG(
        CASE WHEN UPPER(NPS_CATEGORY) = 'PROMOTER'  THEN 1 ELSE 0 END
    ) AS PCT_PROMOTER,

    AVG(
        CASE WHEN UPPER(NPS_CATEGORY) = 'DETRACTOR' THEN 1 ELSE 0 END
    ) AS PCT_DETRACTOR,
    AVG(HAS_MEANINGFUL_COMMENT)     AS PCT_WITH_MEANINGFUL_COMMENT,
    MAX(RESPONSE_DATE)              AS LAST_SURVEY_DATE
FROM ANALYTICS.FACT_SURVEY_RESPONSES
WHERE IS_KNOWN_USER = TRUE
GROUP BY USER_ID;


-- Sanity Check
SELECT * FROM USER_SURVEY_AGG LIMIT 20;
