USE DATABASE CX_ANALYTICS;
USE SCHEMA ANALYTICS;

CREATE OR REPLACE TABLE FACT_SUBSCRIPTIONS_CLEAN AS
WITH fixed_dates AS (
    SELECT
        SUBSCRIPTION_ID,
        USER_ID,

        -- If END_DATE < START_DATE, swap
        CASE 
            WHEN END_DATE < START_DATE THEN END_DATE
            ELSE START_DATE
        END AS START_DATE_CLEAN,

        CASE 
            WHEN END_DATE < START_DATE THEN START_DATE
            ELSE END_DATE
        END AS END_DATE_CLEAN,

        BILLING_PERIOD,
        PRICE_USD,
        IS_ACTIVE,
        IS_DURATION_VALID,
        IS_PRICE_VALID,
        IS_KNOWN_USER
    FROM CX_ANALYTICS.TRANSFORM.STG_SUBSCRIPTIONS
)
SELECT
    SUBSCRIPTION_ID,
    USER_ID,
    START_DATE_CLEAN AS START_DATE,
    END_DATE_CLEAN   AS END_DATE,

    -- Recompute duration after fixing flips
    DATEDIFF('day', START_DATE_CLEAN, END_DATE_CLEAN) AS DURATION_DAYS,

    BILLING_PERIOD,
    PRICE_USD,
    IS_ACTIVE,
    IS_PRICE_VALID,
    IS_KNOWN_USER,

    -- New duration-valid flag based on the corrected dates
    CASE
        WHEN END_DATE_CLEAN >= START_DATE_CLEAN
             AND DATEDIFF('day', START_DATE_CLEAN, END_DATE_CLEAN) BETWEEN 0 AND 365*5
        THEN TRUE
        ELSE FALSE
    END AS IS_DURATION_VALID_CLEAN

FROM fixed_dates;
