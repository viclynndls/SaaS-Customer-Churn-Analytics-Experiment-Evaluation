USE DATABASE CX_ANALYTICS;
USE SCHEMA ANALYTICS;

-- set once per worksheet/session
SET REF_DATE = TO_DATE('2024-12-31');  -- ðŸ‘ˆ change this

CREATE OR REPLACE TABLE USER_CHURN_LABEL AS
WITH last_event AS (
    SELECT
        USER_ID,
        MAX(EVENT_DATE) AS LAST_EVENT_DATE
    FROM ANALYTICS.FACT_EVENTS
    WHERE IS_KNOWN_USER = TRUE
    GROUP BY USER_ID
),
last_sub AS (
    SELECT
        USER_ID,
        MAX(END_DATE) AS LAST_SUB_END
    FROM ANALYTICS.FACT_SUBSCRIPTIONS_CLEAN
    WHERE IS_KNOWN_USER = TRUE
          AND IS_DURATION_VALID_CLEAN = TRUE
          AND IS_PRICE_VALID = TRUE
    GROUP BY USER_ID
)
SELECT
    u.USER_ID,
    le.LAST_EVENT_DATE,
    ls.LAST_SUB_END,
    GREATEST(DATEDIFF('day', le.LAST_EVENT_DATE, $REF_DATE), 0)
AS DAYS_SINCE_LAST_EVENT,

    CASE
        WHEN ls.LAST_SUB_END IS NOT NULL
             AND ls.LAST_SUB_END < DATEADD('day', -45, $REF_DATE) THEN 1
        WHEN le.LAST_EVENT_DATE IS NOT NULL
             AND le.LAST_EVENT_DATE < DATEADD('day', -45, $REF_DATE) THEN 1
        ELSE 0
    END AS CHURNED_AS_OF_REF_DATE

FROM ANALYTICS.DIM_USERS u
LEFT JOIN last_event le ON u.USER_ID = le.USER_ID
LEFT JOIN last_sub   ls ON u.USER_ID = ls.USER_ID;

-- Sanity Check
SELECT * FROM USER_CHURN_LABEL LIMIT 20;
